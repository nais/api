-- name: DailyVulnerabilityForTeam :many
SELECT
    sum(critical) AS critical,
    sum(high) AS high,
    sum(medium) AS medium,
    sum(low) AS low,
    sum(unassigned) AS unassigned,
    sum(risk_score) AS risk_score,
    date
FROM
    vulnerability_metrics
WHERE
    date >= @from_date::date
  AND date <= @to_date::date
  AND dependencytrack_project_id in (SELECT projectId
FROM "dependencytrack_projects"
WHERE CAST("team_slug" AS text) = @team_slug::slug)
GROUP BY
    date
ORDER BY
    date ASC;

-- name: VulnerabilityMetricsUpsert :batchexec
INSERT INTO vulnerability_metrics (date, dependencytrack_project_id, critical, high, medium, low, unassigned, risk_score)
VALUES (@date, @dependencytrack_project_id, @critical, @high, @medium, @low, @unassigned, @risk_score)
    ON CONFLICT ON CONSTRAINT vulnerability_metric DO NOTHING;

-- name: CreateDependencytrackProject :exec
INSERT INTO dependencytrack_projects (environment, team_slug, app, projectId)
VALUES (@environment, @team_slug, @app, @projectId)
    ON CONFLICT ON CONSTRAINT dependencytrack_projects_key DO NOTHING;
