package vulnerability

import (
	"context"

	"github.com/sirupsen/logrus"
	"github.com/sourcegraph/conc/pool"
	"github.com/vikstrous/dataloadgen"
)

type ctxKey int

const loadersKey ctxKey = iota

func NewLoaderContext(ctx context.Context, dpClient *Client, logger logrus.FieldLogger, defaultOpts []dataloadgen.Option) context.Context {
	return context.WithValue(ctx, loadersKey, newLoaders(dpClient, logger, defaultOpts))
}

func fromContext(ctx context.Context) *loaders {
	return ctx.Value(loadersKey).(*loaders)
}

type loaders struct {
	imageLoader *dataloadgen.Loader[string, *ImageDetails]
}

func newLoaders(dpClient *Client, logger logrus.FieldLogger, opts []dataloadgen.Option) *loaders {
	userLoader := &dataloader{client: dpClient, log: logger}

	return &loaders{
		imageLoader: dataloadgen.NewLoader(userLoader.list, opts...),
	}
}

type dataloader struct {
	client *Client
	log    logrus.FieldLogger
}

func (l dataloader) list(ctx context.Context, imageRef []string) ([]*ImageDetails, []error) {
	wg := pool.New().WithContext(ctx)

	ret := make([]*ImageDetails, len(imageRef))
	errs := make([]error, len(imageRef))

	for i, ref := range imageRef {
		wg.Go(func(ctx context.Context) error {
			m, err := l.client.GetMetadataForImage(ctx, ref)
			if err != nil {
				errs[i] = err
			} else {
				ret[i] = m
			}
			return nil
		})
	}

	return ret, errs
}
