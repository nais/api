package vulnerability

import (
	"context"
	"time"

	"github.com/nais/api/internal/graph/sortfilter"
	"github.com/nais/api/internal/slug"
	"github.com/nais/api/internal/team"
	"github.com/nais/api/internal/workload"
	"github.com/nais/v13s/pkg/api/vulnerabilities"
)

var SortFilterImageVulnerabilities = map[ImageVulnerabilityOrderField]vulnerabilities.OrderByField{
	"SEVERITY":   vulnerabilities.OrderBySeverity,
	"IDENTIFIER": vulnerabilities.OrderByCveId,
	"PACKAGE":    vulnerabilities.OrderByPackage,
	"STATE":      vulnerabilities.OrderByReason,
	"SUPPRESSED": vulnerabilities.OrderBySuppressed,
}

var SortFilterWorkloadSummaries = map[VulnerabilitySummaryOrderByField]vulnerabilities.OrderByField{
	"NAME":                              vulnerabilities.OrderByWorkload,
	"ENVIRONMENT":                       vulnerabilities.OrderByCluster,
	"VULNERABILITY_RISK_SCORE":          vulnerabilities.OrderByRiskScore,
	"VULNERABILITY_SEVERITY_CRITICAL":   vulnerabilities.OrderByCritical,
	"VULNERABILITY_SEVERITY_HIGH":       vulnerabilities.OrderByHigh,
	"VULNERABILITY_SEVERITY_MEDIUM":     vulnerabilities.OrderByMedium,
	"VULNERABILITY_SEVERITY_LOW":        vulnerabilities.OrderByLow,
	"VULNERABILITY_SEVERITY_UNASSIGNED": vulnerabilities.OrderByUnassigned,
}

const (
	TeamOrderFieldRiskScore                 team.TeamOrderField = "RISK_SCORE"
	TeamOrderFieldCriticalVulnerabilities   team.TeamOrderField = "CRITICAL_VULNERABILITIES"
	TeamOrderFieldHighVulnerabilities       team.TeamOrderField = "HIGH_VULNERABILITIES"
	TeamOrderFieldMediumVulnerabilities     team.TeamOrderField = "MEDIUM_VULNERABILITIES"
	TeamOrderFieldLowVulnerabilities        team.TeamOrderField = "LOW_VULNERABILITIES"
	TeamOrderFieldUnassignedVulnerabilities team.TeamOrderField = "UNASSIGNED_VULNERABILITIES"
)

func init() {
	workloadInit()
	teamInit()
}

func workloadInit() {
	summarySorter := func(fn func(sum *ImageVulnerabilitySummary) int) sortfilter.ConcurrentSortFunc[workload.Workload] {
		return func(ctx context.Context, a workload.Workload) int {
			ref, err := GetImageMetadata(ctx, a.GetImageString())
			if err != nil {
				return -1
			}

			if ref == nil || ref.Summary == nil {
				return -1
			}

			return fn(ref.Summary)
		}
	}

	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_RISK_SCORE", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.RiskScore
	}), "NAME", "ENVIRONMENT")
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_CRITICAL", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Critical
	}), "NAME", "ENVIRONMENT")
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_HIGH", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.High
	}), "NAME", "ENVIRONMENT")
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_MEDIUM", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Medium
	}), "NAME", "ENVIRONMENT")
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_LOW", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Low
	}), "NAME", "ENVIRONMENT")
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_UNASSIGNED", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Unassigned
	}), "NAME", "ENVIRONMENT")
}

func teamInit() {
	team.AllTeamOrderFields = append(team.AllTeamOrderFields, TeamOrderFieldRiskScore, TeamOrderFieldCriticalVulnerabilities, TeamOrderFieldHighVulnerabilities, TeamOrderFieldMediumVulnerabilities, TeamOrderFieldLowVulnerabilities, TeamOrderFieldUnassignedVulnerabilities)

	opts := func(slg slug.Slug) []vulnerabilities.Option {
		return []vulnerabilities.Option{
			vulnerabilities.NamespaceFilter(string(slg)),
			vulnerabilities.Since(time.Now().Add(-24 * time.Hour)),
		}
	}

	team.SortFilter.RegisterConcurrentSort(TeamOrderFieldRiskScore, func(ctx context.Context, a *team.Team) int {
		ivh, err := getVulnerabilityHistory(ctx, opts(a.Slug))
		if err != nil || len(ivh.Samples) == 0 {
			return -1
		}

		return ivh.Samples[0].Summary.RiskScore
	}, "_SLUG")
	team.SortFilter.RegisterConcurrentSort(TeamOrderFieldCriticalVulnerabilities, func(ctx context.Context, a *team.Team) int {
		ivh, err := getVulnerabilityHistory(ctx, opts(a.Slug))
		if err != nil || len(ivh.Samples) == 0 {
			return -1
		}

		return ivh.Samples[0].Summary.Critical
	}, "_SLUG")
	team.SortFilter.RegisterConcurrentSort(TeamOrderFieldHighVulnerabilities, func(ctx context.Context, a *team.Team) int {
		ivh, err := getVulnerabilityHistory(ctx, opts(a.Slug))
		if err != nil || len(ivh.Samples) == 0 {
			return -1
		}

		return ivh.Samples[0].Summary.High
	}, "_SLUG")
	team.SortFilter.RegisterConcurrentSort(TeamOrderFieldMediumVulnerabilities, func(ctx context.Context, a *team.Team) int {
		ivh, err := getVulnerabilityHistory(ctx, opts(a.Slug))
		if err != nil || len(ivh.Samples) == 0 {
			return -1
		}

		return ivh.Samples[0].Summary.Medium
	}, "_SLUG")
	team.SortFilter.RegisterConcurrentSort(TeamOrderFieldLowVulnerabilities, func(ctx context.Context, a *team.Team) int {
		ivh, err := getVulnerabilityHistory(ctx, opts(a.Slug))
		if err != nil || len(ivh.Samples) == 0 {
			return -1
		}

		return ivh.Samples[0].Summary.Low
	}, "_SLUG")
	team.SortFilter.RegisterConcurrentSort(TeamOrderFieldUnassignedVulnerabilities, func(ctx context.Context, a *team.Team) int {
		ivh, err := getVulnerabilityHistory(ctx, opts(a.Slug))
		if err != nil || len(ivh.Samples) == 0 {
			return -1
		}

		return ivh.Samples[0].Summary.Unassigned
	}, "_SLUG")
}
