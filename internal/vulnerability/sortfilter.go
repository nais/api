package vulnerability

import (
	"context"
	"strings"

	"github.com/nais/api/internal/graph/model"
	"github.com/nais/api/internal/graph/sortfilter"
	"github.com/nais/api/internal/workload"
	"k8s.io/utils/ptr"
)

var SortFilterImageVulnerabilities = sortfilter.New[*ImageVulnerability, ImageVulnerabilityOrderField, struct{}]()

type (
	SortFilterImageVulnerabilitiesTieBreaker = sortfilter.TieBreaker[ImageVulnerabilityOrderField]
)

func init() {
	workloadInit()

	identifierTieBreaker := SortFilterImageVulnerabilitiesTieBreaker{
		Field:     "IDENTIFIER",
		Direction: ptr.To(model.OrderDirectionAsc),
	}
	packageTieBreaker := SortFilterImageVulnerabilitiesTieBreaker{
		Field:     "PACKAGE",
		Direction: ptr.To(model.OrderDirectionAsc),
	}
	severityTieBreaker := SortFilterImageVulnerabilitiesTieBreaker{
		Field:     "SEVERITY",
		Direction: ptr.To(model.OrderDirectionDesc),
	}

	SortFilterImageVulnerabilities.RegisterSort("IDENTIFIER", func(ctx context.Context, a, b *ImageVulnerability) int {
		return strings.Compare(a.Identifier, b.Identifier)
	}, severityTieBreaker, packageTieBreaker)
	SortFilterImageVulnerabilities.RegisterSort("PACKAGE", func(ctx context.Context, a, b *ImageVulnerability) int {
		return strings.Compare(a.Package, b.Package)
	}, severityTieBreaker, identifierTieBreaker)
	SortFilterImageVulnerabilities.RegisterSort("STATE", func(ctx context.Context, a, b *ImageVulnerability) int {
		return strings.Compare(a.State.String(), b.State.String())
	}, severityTieBreaker, identifierTieBreaker, packageTieBreaker)
	SortFilterImageVulnerabilities.RegisterConcurrentSort("SUPPRESSED", func(ctx context.Context, a *ImageVulnerability) int {
		vuln, err := GetImageAnalysisTrail(ctx, a)
		if err != nil {
			return 0
		}

		if vuln.Suppressed {
			return 1
		}

		return 0
	}, severityTieBreaker, identifierTieBreaker, packageTieBreaker)
	SortFilterImageVulnerabilities.RegisterSort("SEVERITY", func(ctx context.Context, a, b *ImageVulnerability) int {
		severityToScore := map[ImageVulnerabilitySeverity]int{
			ImageVulnerabilitySeverityCritical:   5,
			ImageVulnerabilitySeverityHigh:       4,
			ImageVulnerabilitySeverityMedium:     3,
			ImageVulnerabilitySeverityLow:        2,
			ImageVulnerabilitySeverityUnassigned: 1,
		}

		return severityToScore[a.Severity] - severityToScore[b.Severity]
	}, identifierTieBreaker, packageTieBreaker)
}

func workloadInit() {
	summarySorter := func(fn func(sum *ImageVulnerabilitySummary) int) sortfilter.ConcurrentSortFunc[workload.Workload] {
		return func(ctx context.Context, a workload.Workload) int {
			ref, err := GetImageMetadata(ctx, a.GetImageString())
			if err != nil {
				return -1
			}

			if ref == nil || ref.Summary == nil {
				return -1
			}

			return fn(ref.Summary)
		}
	}

	tieBreakers := []workload.SortFilterTieBreaker{
		{
			Field:     "NAME",
			Direction: ptr.To(model.OrderDirectionAsc),
		},
		{
			Field:     "ENVIRONMENT",
			Direction: ptr.To(model.OrderDirectionAsc),
		},
	}

	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_RISK_SCORE", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.RiskScore
	}), tieBreakers...)
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_CRITICAL", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Critical
	}), tieBreakers...)
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_HIGH", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.High
	}), tieBreakers...)
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_MEDIUM", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Medium
	}), tieBreakers...)
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_LOW", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Low
	}), tieBreakers...)
	workload.SortFilter.RegisterConcurrentSort("VULNERABILITY_SEVERITY_UNASSIGNED", summarySorter(func(sum *ImageVulnerabilitySummary) int {
		return sum.Unassigned
	}), tieBreakers...)
}
