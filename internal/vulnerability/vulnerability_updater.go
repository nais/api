package vulnerability

import (
	"context"
	"fmt"
	"time"

	"github.com/jackc/pgx/v5/pgtype"
	"github.com/nais/api/internal/database"
	"github.com/nais/api/internal/database/gensql"
	"github.com/nais/api/internal/graph"
	"github.com/nais/api/internal/k8s"
	"github.com/nais/api/internal/slug"
	"github.com/nais/api/internal/thirdparty/dependencytrack"
	"github.com/sirupsen/logrus"
)

type DependencytrackClient interface {
	graph.DependencytrackClient
	GetProjectMetric(ctx context.Context, app *dependencytrack.AppInstance) (*dependencytrack.ProjectMetric, error)
}

type Updater struct {
	dpTrackClient DependencytrackClient
	k8sClient     *k8s.Client
	db            database.Database
	log           logrus.FieldLogger
}

func NewMetricUpdater(client *k8s.Client, dpTrackClient DependencytrackClient, db database.Database, log logrus.FieldLogger) *Updater {
	return &Updater{
		dpTrackClient: dpTrackClient,
		k8sClient:     client,
		db:            db,
		log:           log,
	}
}

func (u *Updater) UpdateVulnerabilityMetrics(ctx context.Context) (int, error) {
	// Get all teams
	teams, err := u.db.GetActiveTeams(ctx)
	if err != nil {
		return 0, err
	}

	results := 0
	batchErrors := 0
	for _, team := range teams {
		log := u.log.WithField("team", team.Slug)
		appInstances, err := u.getApps(ctx, team.Slug.String())
		if err != nil {
			return 0, fmt.Errorf("getting getApps for team %s: %v", team.Slug, err)
		}

		log = log.WithField("num_apps", len(appInstances))
		batch, err := u.UpsertBatchParams(ctx, team.Slug, appInstances)
		if err != nil {
			u.log.Errorf("creating upsert batch for team %s: %v", team.Slug, err)
			batchErrors++
		}
		u.db.VulnerabilityMetricsUpsert(ctx, batch).Exec(func(i int, err error) {
			if err != nil {
				u.log.Errorf("updating vulnerability metrics for team %s: %v", team.Slug, err)
				batchErrors++
			}
		})
		log.WithFields(logrus.Fields{
			"num_rows":   len(batch),
			"num_errors": batchErrors,
		}).Debugf("batch upsert")
		results += len(batch) - batchErrors
	}
	return results, nil
}

func (u *Updater) getApps(ctx context.Context, team string) ([]*dependencytrack.AppInstance, error) {
	apps, err := u.k8sClient.Apps(ctx, team)
	if err != nil {
		return nil, err
	}

	appInstances := make([]*dependencytrack.AppInstance, 0)
	for _, app := range apps {
		appInstances = append(appInstances, &dependencytrack.AppInstance{
			Env:   app.Env.Name,
			Team:  team,
			App:   app.Name,
			Image: app.Image,
		})
	}
	return appInstances, nil
}

func (u *Updater) UpsertBatchParams(ctx context.Context, teamSlug slug.Slug, appInstances []*dependencytrack.AppInstance) ([]gensql.VulnerabilityMetricsUpsertParams, error) {
	vulnerabilityMetricsUpsertParams := make([]gensql.VulnerabilityMetricsUpsertParams, 0)
	for _, app := range appInstances {
		metrics, err := u.dpTrackClient.GetProjectMetric(ctx, app)
		if err != nil {
			return nil, fmt.Errorf("getting project metrics for app %s: %v", app.App, err)
		}

		uuId, err := metrics.ProjectID.AsUUID()
		if err != nil {
			return nil, fmt.Errorf("parsing project id %s: %v", metrics.ProjectID, err)
		}

		dependencytrackProjectParams := gensql.CreateDependencytrackProjectParams{
			Environment: app.Env,
			TeamSlug:    teamSlug,
			App:         app.App,
			Projectid:   uuId,
		}
		err = u.db.CreateDependencytrackProject(ctx, dependencytrackProjectParams)
		if err != nil {
			return nil, fmt.Errorf("creating dependencytrack project for app %s: %v", app.App, err)
		}

		vulnerabilityMetricsUpsertParams = append(vulnerabilityMetricsUpsertParams, gensql.VulnerabilityMetricsUpsertParams{
			Date:                     pgtype.Date{Time: time.Now().UTC(), Valid: true},
			DependencytrackProjectID: uuId,
			High:                     int32(metrics.VulnerabilitySummary.High),
			Medium:                   int32(metrics.VulnerabilitySummary.Medium),
			Low:                      int32(metrics.VulnerabilitySummary.Low),
			Critical:                 int32(metrics.VulnerabilitySummary.Critical),
			RiskScore:                float64(metrics.VulnerabilitySummary.RiskScore),
		})
	}

	return vulnerabilityMetricsUpsertParams, nil
}
