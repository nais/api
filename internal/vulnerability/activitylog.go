package vulnerability

import (
	"fmt"

	"github.com/nais/api/internal/activitylog"
)

const (
	activityLogEntryResourceTypeVulnerability activitylog.ActivityLogEntryResourceType = "VULNERABILITY"
)

func init() {
	activitylog.RegisterTransformer(activityLogEntryResourceTypeVulnerability, func(entry activitylog.GenericActivityLogEntry) (activitylog.ActivityLogEntry, error) {
		switch entry.Action {
		case activitylog.ActivityLogEntryActionUpdated:
			data, err := activitylog.UnmarshalData[VulnerabilityActivityLogEntryData](entry)
			if err != nil {
				return nil, fmt.Errorf("failed to unmarshal vulnerability updated activity log entry data: %w", err)
			}
			return VulnerabilityUpdatedActivityLogEntry{
				GenericActivityLogEntry: entry.WithMessage("Updated vulnerability"),
				Data:                    data,
			}, nil
		default:
			return nil, fmt.Errorf("unsupported vulnerability activity log entry action: %q", entry.Action)
		}
	})

	activitylog.RegisterFilter("VULNERABILITY_UPDATED", activitylog.ActivityLogEntryActionUpdated, activityLogEntryResourceTypeVulnerability)
}

type VulnerabilityUpdatedActivityLogEntry struct {
	activitylog.GenericActivityLogEntry
	Data *VulnerabilityActivityLogEntryData `json:"data"`
}

type VulnerabilityActivityLogEntryData struct {
	Identifier          string                         `json:"identifier"`
	Severity            ImageVulnerabilitySeverity     `json:"severity"`
	Package             string                         `json:"package"`
	PreviousSuppression *ImageVulnerabilitySuppression `json:"previousSuppression,omitempty"`
	NewSuppression      *ImageVulnerabilitySuppression `json:"newSuppression,omitempty"`
}
