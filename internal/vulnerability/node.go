package vulnerability

import (
	"fmt"
	"strconv"

	"github.com/nais/api/internal/graph/ident"
)

type identType int

const (
	identVulnerability identType = iota
	identWorkloadVulnerabilitySummary
	identWorkloadVulnerabilityHistory
)

func init() {
	// implements node pattern, e.g. retrieves a node by its identifier
	ident.RegisterIdentType(identVulnerability, "VUL", getVulnerabilityByIdent)
	ident.RegisterIdentType(identWorkloadVulnerabilitySummary, "WVS", getWorkloadVulnerabilitySummaryByIdent)
	ident.RegisterIdentType(identWorkloadVulnerabilityHistory, "WVH", getWorkloadVulnerabilityHistoryByIdent)
}

func newWorkloadVulnerabilitySummaryIdent(w WorkloadReference) ident.Ident {
	return ident.NewIdent(
		identWorkloadVulnerabilitySummary,
		w.Environment,
		w.Team,
		w.WorkloadType,
		w.Name,
	)
}

func newWorkloadVulnerabilityHistoryIdent(w WorkloadReference, lastUpdated int64) ident.Ident {
	return ident.NewIdent(
		identWorkloadVulnerabilityHistory,
		w.Environment,
		w.Team,
		w.WorkloadType,
		w.Name,
		strconv.FormatInt(lastUpdated, 10),
	)
}

func parseWorkloadVulnerabilitySummaryIdent(id ident.Ident) (WorkloadReference, error) {
	parts := id.Parts()
	if len(parts) != 4 {
		return WorkloadReference{}, fmt.Errorf("invalid workload vulnerability summary ident")
	}

	return WorkloadReference{
		Environment:  parts[0],
		Team:         parts[1],
		WorkloadType: parts[2],
		Name:         parts[3],
	}, nil
}

func parseWorkloadVulnerabilityHistoryIdent(id ident.Ident) (WorkloadReference, int64, error) {
	parts := id.Parts()
	if len(parts) != 5 {
		return WorkloadReference{}, 0, fmt.Errorf("invalid workload vulnerability history ident")
	}

	lastUpdated, err := strconv.ParseInt(parts[4], 10, 64)
	if err != nil {
		return WorkloadReference{}, 0, fmt.Errorf("invalid lastUpdated value: %w", err)
	}

	return WorkloadReference{
		Environment:  parts[0],
		Team:         parts[1],
		WorkloadType: parts[2],
		Name:         parts[3],
	}, lastUpdated, nil
}
