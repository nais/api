version: "2"
rules:
  - name: "always-order-by"
    rule: |
      query.cmd == "many" && !query.sql.contains("ORDER BY")
    message: |
      SELECT statements must have an ORDER BY clause
sql:
  - &default_domain
    name: "Users SQL"
    engine: "postgresql"
    schema: "../internal/database/migrations"
    queries: "../internal/v1/user/queries"
    rules:
      - "always-order-by"
    gen:
      go: &default_go
        package: "usersql"
        out: "../internal/v1/user/usersql"
        sql_package: "pgx/v5"
        emit_interface: true
        emit_result_struct_pointers: true
        emit_prepared_queries: true
        emit_all_enum_values: true
        emit_enum_valid_method: true
        emit_pointers_for_null_types: true
        emit_empty_slices: true
        json_tags_id_uppercase: true
        omit_unused_structs: true
        omit_sqlc_version: true
        overrides:
          - db_type: "slug"
            go_type: "*github.com/nais/api/internal/slug.Slug"
            nullable: true
          - db_type: "slug"
            go_type: "github.com/nais/api/internal/slug.Slug"
          - db_type: "uuid"
            go_type: "*github.com/google/uuid.UUID"
            nullable: true
          - db_type: "uuid"
            go_type: "github.com/google/uuid.UUID"

  - <<: *default_domain
    name: "Teams SQL"
    queries: "../internal/v1/team/queries"
    gen:
      go:
        <<: *default_go
        package: "teamsql"
        out: "../internal/v1/team/teamsql"

  - <<: *default_domain
    name: "Roles SQL"
    queries: "../internal/v1/role/queries"
    gen:
      go:
        <<: *default_go
        package: "rolesql"
        out: "../internal/v1/role/rolesql"

  - <<: *default_domain
    name: "Audit SQL"
    queries: "../internal/v1/auditv1/queries"
    gen:
      go:
        <<: *default_go
        package: "auditsql"
        out: "../internal/v1/auditv1/auditsql"

  - <<: *default_domain
    name: "GitHub repositories SQL"
    queries: "../internal/v1/github/repository/queries"
    gen:
      go:
        <<: *default_go
        package: "repositorysql"
        out: "../internal/v1/github/repository/repositorysql"

  - <<: *default_domain
    name: "Cost SQL"
    queries: "../internal/v1/cost/queries"
    gen:
      go:
        <<: *default_go
        package: "costsql"
        out: "../internal/v1/cost/costsql"

  - <<: *default_domain
    name: "Reconciler SQL"
    queries: "../internal/v1/reconciler/queries"
    gen:
      go:
        <<: *default_go
        package: "reconcilersql"
        out: "../internal/v1/reconciler/reconcilersql"

  - <<: *default_domain
    name: "Environment SQL"
    queries: "../internal/v1/environment/queries"
    gen:
      go:
        <<: *default_go
        package: "environmentsql"
        out: "../internal/v1/environment/environmentsql"

  - <<: *default_domain
    name: "Teams SQL for gRPC"
    queries: "../internal/grpc/grpcteam/queries"
    gen:
      go:
        <<: *default_go
        package: "grpcteamsql"
        out: "../internal/grpc/grpcteam/grpcteamsql"

  - <<: *default_domain
    name: "Users SQL for gRPC"
    queries: "../internal/grpc/grpcuser/queries"
    gen:
      go:
        <<: *default_go
        package: "grpcusersql"
        out: "../internal/grpc/grpcuser/grpcusersql"

  - <<: *default_domain
    name: "Reconcilers SQL for gRPC"
    queries: "../internal/grpc/grpcreconciler/queries"
    gen:
      go:
        <<: *default_go
        package: "grpcreconcilersql"
        out: "../internal/grpc/grpcreconciler/grpcreconcilersql"
